<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Calculator - Sandrine & Olivier</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #dbeafe 0%, #c7d2fe 100%);
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">
            <div>
                <div class="spinner"></div>
                <p class="mt-4 text-gray-600">Budget Calculator laden...</p>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { 
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, 
            BarChart, Bar, PieChart, Cell, AreaChart, Area, Pie 
        } = Recharts;

        const { useState, useEffect } = React;

        // Google Sheets Configuration
        const SHEETS_CONFIG = {
            spreadsheetId: '13V8sTjTH2kYJ6KGWQioRKKuVfrKe05PF9qBXkJOWnFo',
            apiKey: 'AIzaSyAYL-9uaenj449Uxv6dCXqA-5Mrazgft-w',
            sheetName: 'BudgetData'
        };

        function BudgetCalculator() {
            const [activeTab, setActiveTab] = useState('budget');
            const [isLoading, setIsLoading] = useState(true);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [lastSync, setLastSync] = useState(null);
            
            // Current selected month/year
            const [selectedDate, setSelectedDate] = useState(() => {
                const now = new Date();
                return {
                    month: now.getMonth(),
                    year: now.getFullYear()
                };
            });

            // All data stored per month
            const [monthlyData, setMonthlyData] = useState({});
            const [editingExpense, setEditingExpense] = useState(null);
            const [newExpense, setNewExpense] = useState({
                name: '',
                amount: 0,
                proportional: true
            });

            const [editingNames, setEditingNames] = useState(false);
            const [tempNames, setTempNames] = useState({
                person1: 'Sandrine',
                person2: 'Olivier'
            });

            // Network status monitoring
            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            // Auto-load and sync data
            useEffect(() => {
                loadDataFromSources();
            }, []);

            // Auto-save whenever data changes
            useEffect(() => {
                if (!isLoading && Object.keys(monthlyData).length > 0) {
                    saveDataToSources();
                }
            }, [monthlyData, isLoading]);

            // Load data from both localStorage and Google Sheets
            const loadDataFromSources = async () => {
                try {
                    // 1. Load from localStorage first (instant)
                    const localData = localStorage.getItem('budgetCalculatorData');
                    if (localData) {
                        const parsed = JSON.parse(localData);
                        setMonthlyData(parsed.monthlyData || {});
                        setLastSync(parsed.lastSync || null);
                    }

                    // 2. Try to load from Google Sheets (if online and configured)
                    if (isOnline && SHEETS_CONFIG.apiKey !== 'YOUR_API_KEY_HERE') {
                        await loadFromGoogleSheets();
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                } finally {
                    setIsLoading(false);
                }
            };

            // Load data from Google Sheets
            const loadFromGoogleSheets = async () => {
                try {
                    const response = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SHEETS_CONFIG.spreadsheetId}/values/${SHEETS_CONFIG.sheetName}!A:H?key=${SHEETS_CONFIG.apiKey}`
                    );
                    
                    if (!response.ok) throw new Error('Failed to fetch from Google Sheets');
                    
                    const data = await response.json();
                    
                    if (data.values && data.values.length > 1) {
                        const sheetData = parseSheetData(data.values);
                        setMonthlyData(sheetData);
                        setLastSync(new Date().toISOString());
                    }
                } catch (error) {
                    console.error('Google Sheets load error:', error);
                    // Fail silently and use local data
                }
            };

            // Parse sheet data into our format
            const parseSheetData = (rows) => {
                const parsedData = {};
                
                // Skip header row
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.length < 4) continue;
                    
                    const [monthName, year, sandrineIncome, olivierIncome, expenseName, expenseAmount, expenseType] = row;
                    
                    // Create month key
                    const monthIndex = getMonthIndex(monthName);
                    if (monthIndex === -1) continue;
                    
                    const monthKey = `${year}-${monthIndex.toString().padStart(2, '0')}`;
                    
                    if (!parsedData[monthKey]) {
                        parsedData[monthKey] = {
                            incomes: {
                                person1: { name: 'Sandrine', amount: parseFloat(sandrineIncome) || 0 },
                                person2: { name: 'Olivier', amount: parseFloat(olivierIncome) || 0 }
                            },
                            expenses: []
                        };
                    }
                    
                    // Add expense if exists
                    if (expenseName && expenseAmount) {
                        parsedData[monthKey].expenses.push({
                            id: Date.now() + Math.random(),
                            name: expenseName,
                            amount: parseFloat(expenseAmount) || 0,
                            proportional: expenseType === 'Proportioneel'
                        });
                    }
                }
                
                return parsedData;
            };

            // Save data to both localStorage and Google Sheets
            const saveDataToSources = async () => {
                try {
                    // 1. Always save to localStorage (instant)
                    const dataToSave = {
                        monthlyData,
                        lastSync: new Date().toISOString()
                    };
                    localStorage.setItem('budgetCalculatorData', JSON.stringify(dataToSave));

                    // 2. Save to Google Sheets if online and configured
                    if (isOnline && SHEETS_CONFIG.apiKey !== 'YOUR_API_KEY_HERE') {
                        await saveToGoogleSheets();
                    }
                } catch (error) {
                    console.error('Error saving data:', error);
                }
            };

            // Save data to Google Sheets
            const saveToGoogleSheets = async () => {
                try {
                    const sheetData = convertToSheetFormat();
                    
                    // Clear existing data first
                    await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SHEETS_CONFIG.spreadsheetId}/values/${SHEETS_CONFIG.sheetName}!A:H:clear?key=${SHEETS_CONFIG.apiKey}`,
                        { method: 'POST' }
                    );

                    // Add new data
                    const response = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SHEETS_CONFIG.spreadsheetId}/values/${SHEETS_CONFIG.sheetName}!A1:H${sheetData.length}?valueInputOption=RAW&key=${SHEETS_CONFIG.apiKey}`,
                        {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ values: sheetData })
                        }
                    );

                    if (response.ok) {
                        setLastSync(new Date().toISOString());
                    }
                } catch (error) {
                    console.error('Google Sheets save error:', error);
                }
            };

            // Convert our data format to sheet format
            const convertToSheetFormat = () => {
                const sheetData = [
                    ['Maand', 'Jaar', 'Sandrine Inkomen', 'Olivier Inkomen', 'Uitgave Naam', 'Uitgave Bedrag', 'Uitgave Type', 'Update Tijd']
                ];

                Object.entries(monthlyData).forEach(([monthKey, data]) => {
                    const [year, month] = monthKey.split('-');
                    const monthName = getMonthName(parseInt(month));

                    if (data.expenses.length === 0) {
                        sheetData.push([
                            monthName, year,
                            data.incomes.person1.amount, data.incomes.person2.amount,
                            '', '', '', new Date().toISOString()
                        ]);
                    } else {
                        data.expenses.forEach(expense => {
                            sheetData.push([
                                monthName, year,
                                data.incomes.person1.amount, data.incomes.person2.amount,
                                expense.name, expense.amount,
                                expense.proportional ? 'Proportioneel' : 'Fifty-fifty',
                                new Date().toISOString()
                            ]);
                        });
                    }
                });

                return sheetData;
            };

            // Utility functions
            const getCurrentMonthKey = () => {
                return `${selectedDate.year}-${selectedDate.month.toString().padStart(2, '0')}`;
            };

            const getCurrentMonthData = () => {
                const monthKey = getCurrentMonthKey();
                return monthlyData[monthKey] || {
                    incomes: {
                        person1: { name: 'Sandrine', amount: 0 },
                        person2: { name: 'Olivier', amount: 0 }
                    },
                    expenses: []
                };
            };

            const updateCurrentMonthData = (updates) => {
                const monthKey = getCurrentMonthKey();
                setMonthlyData(prev => ({
                    ...prev,
                    [monthKey]: {
                        ...getCurrentMonthData(),
                        ...updates
                    }
                }));
            };

            const navigateMonth = (direction) => {
                setSelectedDate(prev => {
                    let newMonth = prev.month + direction;
                    let newYear = prev.year;
                    
                    if (newMonth > 11) {
                        newMonth = 0;
                        newYear += 1;
                    } else if (newMonth < 0) {
                        newMonth = 11;
                        newYear -= 1;
                    }
                    
                    return { month: newMonth, year: newYear };
                });
            };

            const getMonthName = (monthIndex) => {
                const months = [
                    'Januari', 'Februari', 'Maart', 'April', 'Mei', 'Juni',
                    'Juli', 'Augustus', 'September', 'Oktober', 'November', 'December'
                ];
                return months[monthIndex];
            };

            const getMonthIndex = (monthName) => {
                const months = [
                    'Januari', 'Februari', 'Maart', 'April', 'Mei', 'Juni',
                    'Juli', 'Augustus', 'September', 'Oktober', 'November', 'December'
                ];
                return months.indexOf(monthName);
            };

            const updateIncome = (person, amount) => {
                const newIncomes = {
                    ...currentData.incomes,
                    [person]: { ...currentData.incomes[person], amount: parseFloat(amount) || 0 }
                };
                updateCurrentMonthData({ incomes: newIncomes });
            };

            const addExpense = () => {
                if (newExpense.name && newExpense.amount > 0) {
                    const newExpenses = [...currentData.expenses, { ...newExpense, id: Date.now() }];
                    updateCurrentMonthData({ expenses: newExpenses });
                    setNewExpense({ name: '', amount: 0, proportional: true });
                }
            };

            const deleteExpense = (id) => {
                const newExpenses = currentData.expenses.filter(exp => exp.id !== id);
                updateCurrentMonthData({ expenses: newExpenses });
            };

            const currentData = getCurrentMonthData();
            const incomes = currentData.incomes;
            const expenses = currentData.expenses;

            // Calculations
            const bothIncomesEntered = incomes.person1.amount > 0 && incomes.person2.amount > 0;
            const totalIncome = incomes.person1.amount + incomes.person2.amount;
            const person1Ratio = totalIncome > 0 ? incomes.person1.amount / totalIncome : 0.5;
            const person2Ratio = totalIncome > 0 ? incomes.person2.amount / totalIncome : 0.5;

            const proportionalExpenses = expenses.filter(exp => exp.proportional);
            const fixedExpenses = expenses.filter(exp => !exp.proportional);

            const totalProportionalExpenses = proportionalExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const totalFixedExpenses = fixedExpenses.reduce((sum, exp) => sum + exp.amount, 0);

            const person1ProportionalShare = totalProportionalExpenses * person1Ratio;
            const person2ProportionalShare = totalProportionalExpenses * person2Ratio;
            const person1FixedShare = totalFixedExpenses / 2;
            const person2FixedShare = totalFixedExpenses / 2;
            const person1Total = person1ProportionalShare + person1FixedShare;
            const person2Total = person2ProportionalShare + person2FixedShare;

            // Analysis data
            const getAnalysisData = () => {
                return Object.entries(monthlyData)
                    .sort(([a], [b]) => a.localeCompare(b))
                    .map(([monthKey, data]) => {
                        const [year, month] = monthKey.split('-');
                        const monthName = getMonthName(parseInt(month));
                        
                        const totalIncome = data.incomes.person1.amount + data.incomes.person2.amount;
                        const totalExpenses = data.expenses.reduce((sum, exp) => sum + exp.amount, 0);
                        
                        return {
                            monthKey,
                            monthName: `${monthName.slice(0, 3)} ${year}`,
                            fullMonth: `${monthName} ${year}`,
                            sandrineIncome: data.incomes.person1.amount,
                            olivierIncome: data.incomes.person2.amount,
                            totalIncome,
                            totalExpenses,
                            savings: totalIncome - totalExpenses,
                            sandrineRatio: totalIncome > 0 ? (data.incomes.person1.amount / totalIncome) * 100 : 50,
                            olivierRatio: totalIncome > 0 ? (data.incomes.person2.amount / totalIncome) * 100 : 50
                        };
                    });
            };

            const analysisData = getAnalysisData();
            const chartColors = {
                sandrine: '#3B82F6',
                olivier: '#10B981',
                expenses: '#F59E0B',
                savings: '#8B5CF6'
            };

            if (isLoading) {
                return (
                    <div className="loading">
                        <div>
                            <div className="spinner"></div>
                            <p className="mt-4 text-gray-600">Data laden...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-6xl mx-auto p-6 bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
                    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                        {/* Header */}
                        <div className="gradient-bg p-6 text-white">
                            <div className="flex justify-between items-start mb-6">
                                <div>
                                    <h1 className="text-3xl font-bold">Budget Calculator</h1>
                                    <p className="text-indigo-100">Sandrine & Olivier</p>
                                </div>
                                
                                {/* Status Indicators */}
                                <div className="flex flex-col items-end gap-2">
                                    <div className={`flex items-center gap-2 px-3 py-1 rounded-full text-sm ${
                                        isOnline ? 'bg-green-500/20 text-green-100' : 'bg-red-500/20 text-red-100'
                                    }`}>
                                        <div className={`w-2 h-2 rounded-full ${isOnline ? 'bg-green-400' : 'bg-red-400'}`}></div>
                                        {isOnline ? 'Online' : 'Offline'}
                                    </div>
                                    
                                    {lastSync && (
                                        <div className="text-xs text-indigo-200">
                                            Laatste sync: {new Date(lastSync).toLocaleString('nl-NL')}
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* Tab Navigation */}
                            <div className="flex justify-center space-x-1 bg-white/10 backdrop-blur-sm rounded-lg p-1">
                                <button
                                    onClick={() => setActiveTab('budget')}
                                    className={`flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all duration-300 ${
                                        activeTab === 'budget' 
                                            ? 'bg-white text-indigo-600 shadow-lg' 
                                            : 'text-white hover:bg-white/20'
                                    }`}
                                >
                                    📅 Budget
                                </button>
                                <button
                                    onClick={() => setActiveTab('analysis')}
                                    className={`flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all duration-300 ${
                                        activeTab === 'analysis' 
                                            ? 'bg-white text-indigo-600 shadow-lg' 
                                            : 'text-white hover:bg-white/20'
                                    }`}
                                >
                                    📊 Analyse
                                </button>
                            </div>
                        </div>

                        <div className="p-8">
                            {activeTab === 'budget' ? (
                                <>
                                    {/* Month Navigation */}
                                    <div className="mb-8 p-6 bg-indigo-50 rounded-lg">
                                        <div className="flex items-center justify-between">
                                            <button
                                                onClick={() => navigateMonth(-1)}
                                                className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                                            >
                                                ← Vorige
                                            </button>
                                            
                                            <div className="text-center">
                                                <h2 className="text-2xl font-bold text-gray-800">
                                                    {getMonthName(selectedDate.month)} {selectedDate.year}
                                                </h2>
                                                {Object.keys(monthlyData).includes(getCurrentMonthKey()) && (
                                                    <div className="text-sm text-green-600 font-medium mt-1">
                                                        ✓ Data opgeslagen
                                                    </div>
                                                )}
                                            </div>
                                            
                                            <button
                                                onClick={() => navigateMonth(1)}
                                                className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                                            >
                                                Volgende →
                                            </button>
                                        </div>
                                    </div>

                                    {/* Income Section */}
                                    <div className="mb-8 p-6 bg-green-50 rounded-lg">
                                        <h2 className="text-xl font-semibold text-gray-700 mb-4">
                                            Inkomsten voor {getMonthName(selectedDate.month)} {selectedDate.year}
                                        </h2>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-600 mb-2">
                                                    Sandrine
                                                </label>
                                                <input
                                                    type="number"
                                                    value={incomes.person1.amount || ''}
                                                    onChange={(e) => updateIncome('person1', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    placeholder="€ 0,00"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-600 mb-2">
                                                    Olivier
                                                </label>
                                                <input
                                                    type="number"
                                                    value={incomes.person2.amount || ''}
                                                    onChange={(e) => updateIncome('person2', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    placeholder="€ 0,00"
                                                />
                                            </div>
                                        </div>
                                        <div className="mt-4 p-3 bg-white rounded-lg">
                                            {bothIncomesEntered ? (
                                                <>
                                                    <div className="text-sm text-gray-600">
                                                        Totaal inkomen: <span className="font-semibold">€{totalIncome.toFixed(2)}</span>
                                                    </div>
                                                    <div className="text-sm text-gray-600">
                                                        Verhouding: Sandrine {Math.round(person1Ratio * 100)}% | Olivier {Math.round(person2Ratio * 100)}%
                                                    </div>
                                                </>
                                            ) : (
                                                <div className="text-sm text-yellow-600 font-medium">
                                                    ⚠️ Vul beide lonen in om de verhouding te berekenen
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* Add Expense Section */}
                                    <div className="mb-8 p-6 bg-yellow-50 rounded-lg">
                                        <h2 className="text-xl font-semibold text-gray-700 mb-4">Nieuwe Uitgave Toevoegen</h2>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <input
                                                type="text"
                                                value={newExpense.name}
                                                onChange={(e) => setNewExpense({...newExpense, name: e.target.value})}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                                placeholder="Uitgave naam"
                                            />
                                            <input
                                                type="number"
                                                value={newExpense.amount || ''}
                                                onChange={(e) => setNewExpense({...newExpense, amount: parseFloat(e.target.value) || 0})}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                                placeholder="€ 0,00"
                                            />
                                            <div className="flex items-center gap-4">
                                                <label className="flex items-center gap-2">
                                                    <input
                                                        type="radio"
                                                        checked={newExpense.proportional}
                                                        onChange={() => setNewExpense({...newExpense, proportional: true})}
                                                        className="text-yellow-600"
                                                    />
                                                    <span className="text-sm">Proportioneel</span>
                                                </label>
                                                <label className="flex items-center gap-2">
                                                    <input
                                                        type="radio"
                                                        checked={!newExpense.proportional}
                                                        onChange={() => setNewExpense({...newExpense, proportional: false})}
                                                        className="text-yellow-600"
                                                    />
                                                    <span className="text-sm">50/50</span>
                                                </label>
                                            </div>
                                        </div>
                                        <button
                                            onClick={addExpense}
                                            className="mt-4 flex items-center gap-2 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors"
                                        >
                                            ➕ Uitgave Toevoegen
                                        </button>
                                    </div>

                                    {/* Expenses List */}
                                    <div className="mb-8">
                                        <h2 className="text-xl font-semibold text-gray-700 mb-4">
                                            Uitgaven voor {getMonthName(selectedDate.month)} {selectedDate.year}
                                        </h2>
                                        {expenses.length === 0 ? (
                                            <div className="text-center py-8 text-gray-500 bg-gray-50 rounded-lg">
                                                📝 Nog geen uitgaven toegevoegd voor deze maand
                                            </div>
                                        ) : (
                                            <div className="space-y-3">
                                                {expenses.map((expense) => (
                                                    <div key={expense.id} className="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                                                        <div className="flex items-center justify-between">
                                                            <div className="flex-1">
                                                                <div className="font-medium text-gray-800">{expense.name}</div>
                                                                <div className="text-sm text-gray-600">
                                                                    €{expense.amount.toFixed(2)} - {expense.proportional ? 'Proportioneel' : 'Fifty-fifty'}
                                                                </div>
                                                            </div>
                                                            <button
                                                                onClick={() => deleteExpense(expense.id)}
                                                                className="p-2 text-red-600 hover:bg-red-100 rounded transition-colors"
                                                            >
                                                                🗑️
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    {/* Results Section */}
                                    {bothIncomesEntered ? (
                                        <div className="mb-8 p-6 bg-blue-50 rounded-lg">
                                            <h2 className="text-xl font-semibold text-gray-700 mb-4">💰 Berekening</h2>
                                            
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div className="bg-white p-6 rounded-lg shadow-sm">
                                                    <h3 className="font-semibold text-blue-600 mb-3 text-lg">👩 Sandrine</h3>
                                                    <div className="space-y-2 text-sm">
                                                        <div className="flex justify-between">
                                                            <span>Proportionele uitgaven:</span>
