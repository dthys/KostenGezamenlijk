<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Calculator - Sandrine & Olivier</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #dbeafe 0%, #c7d2fe 100%);
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .error-banner {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
        }
        
        .success-banner {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">
            <div>
                <div class="spinner"></div>
                <p class="mt-4 text-gray-600">Budget Calculator laden...</p>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        const GOOGLE_CONFIG = {
            API_KEY: 'AIzaSyAYL-9uaenj449Uxv6dCXqA-5Mrazgft-w',
            CLIENT_ID: '429034127132-ouf1as1bgr9qug0odj9bt97j1vjnnp1v.apps.googleusercontent.com',
            DISCOVERY_DOC: 'https://sheets.googleapis.com/$discovery/rest?version=v4',
            SCOPES: 'https://www.googleapis.com/auth/spreadsheets',
            SPREADSHEET_ID: '13V8sTjTH2kYJ6KGWQioRKKuVfrKe05PF9qBXkJOWnFo',
            SHEET_NAME: 'BudgetData'
        };

        // Initialize Recharts components - DISABLED FOR NOW due to loading issues
        let LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, 
            BarChart, Bar, PieChart, Cell, AreaChart, Area, Pie;

        const initializeRecharts = () => {
            // Temporarily disabled due to oneOfType error
            return false;
            /*
            try {
                if (typeof Recharts !== 'undefined' && Recharts.LineChart) {
                    ({ LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, 
                       BarChart, Bar, PieChart, Cell, AreaChart, Area, Pie } = Recharts);
                    return true;
                }
            } catch (error) {
                console.warn('Recharts initialization failed:', error);
            }
            return false;
            */
        };

        function BudgetCalculator() {
            const [activeTab, setActiveTab] = useState('budget');
            const [isLoading, setIsLoading] = useState(true);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [lastSync, setLastSync] = useState(null);
            const [isGoogleAuthorized, setIsGoogleAuthorized] = useState(false);
            const [googleApiLoaded, setGoogleApiLoaded] = useState(false);
            const [googleTokenClient, setGoogleTokenClient] = useState(null);
            const [syncError, setSyncError] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);

            // Initialize libraries with better error handling
            useEffect(() => {
                const initLibraries = async () => {
                    console.log('Starting library initialization...');
                    
                    // Initialize Google API with new Google Identity Services
                    try {
                        if (typeof gapi === 'undefined') {
                            throw new Error('Google API script not loaded');
                        }

                        console.log('Loading Google API client...');
                        
                        // Load client module
                        await new Promise((resolve, reject) => {
                            gapi.load('client', {
                                callback: () => {
                                    console.log('client module loaded');
                                    resolve();
                                },
                                onerror: (error) => {
                                    console.error('Failed to load client:', error);
                                    reject(new Error('Failed to load client module'));
                                }
                            });
                        });
            
                        console.log('Initializing Google API client...');
                        await gapi.client.init({
                            apiKey: GOOGLE_CONFIG.API_KEY,
                            discoveryDocs: [GOOGLE_CONFIG.DISCOVERY_DOC],
                        });
            
                        console.log('Google API client initialized successfully');
                        setGoogleApiLoaded(true);
                        setSyncError(null);

                        // Initialize Google Identity Services (new auth method)
                        if (typeof google !== 'undefined' && google.accounts) {
                            console.log('Initializing Google Identity Services...');
                            const tokenClient = google.accounts.oauth2.initTokenClient({
                                client_id: GOOGLE_CONFIG.CLIENT_ID,
                                scope: GOOGLE_CONFIG.SCOPES,
                                callback: (response) => {
                                console.log('OAuth token received:', response);
                                if (response.access_token) {
                                    // Set the access token in the Google API client
                                    gapi.client.setToken({
                                        access_token: response.access_token
                                    });
                                    setIsGoogleAuthorized(true);
                                    loadFromGoogleSheets();
                                }
                            },
                                error_callback: (error) => {
                                    console.error('OAuth error:', error);
                                    setSyncError(`Authentication error: ${error.type || error.message}`);
                                }
                            });
                            setGoogleTokenClient(tokenClient);
                            console.log('Google Identity Services initialized');
                        } else {
                            throw new Error('Google Identity Services not available');
                        }
                        
                    } catch (error) {
                        console.error('Google API initialization failed:', error);
                        setGoogleApiLoaded(false);
                        setSyncError(`Google API Error: ${error.message}`);
                    }

                    setIsLoading(false);
                };

                // Add a small delay to ensure all scripts are loaded
                setTimeout(initLibraries, 1000);
            }, []);
            
            // Current selected month/year
            const [selectedDate, setSelectedDate] = useState(() => {
                const now = new Date();
                return {
                    month: now.getMonth(),
                    year: now.getFullYear()
                };
            });

            // All data stored per month - using in-memory storage
            const [monthlyData, setMonthlyData] = useState({});
            const [newExpense, setNewExpense] = useState({
                name: '',
                amount: 0,
                proportional: true
            });

            // Network status monitoring
            useEffect(() => {
                const handleOnline = () => {
                    setIsOnline(true);
                    setSyncError(null);
                };
                const handleOffline = () => {
                    setIsOnline(false);
                    setSyncError('Offline - changes will sync when connection is restored');
                };
                
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            // Auto-sync to Google Sheets when data changes - with debouncing
            useEffect(() => {
                if (isGoogleAuthorized && Object.keys(monthlyData).length > 0 && isOnline) {
                    const timeoutId = setTimeout(() => {
                        saveToGoogleSheets();
                    }, 3000); // Increased delay to avoid rapid saves

                    return () => clearTimeout(timeoutId);
                }
            }, [monthlyData, isGoogleAuthorized, isOnline]);

            // Parse sheet data helper function
            const parseSheetData = useCallback((rows) => {
                if (!rows || rows.length <= 1) return {};
                
                const data = {};
                
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row || row.length < 4) continue;
                    
                    const monthName = row[0];
                    const year = row[1];
                    const sandrineIncome = parseFloat(row[2]) || 0;
                    const olivierIncome = parseFloat(row[3]) || 0;
                    const expenseName = row[4] || '';
                    const expenseAmount = parseFloat(row[5]) || 0;
                    const expenseType = row[6] || '';
                    
                    const monthIndex = getMonthIndex(monthName);
                    if (monthIndex === -1) continue;
                    
                    const monthKey = `${year}-${monthIndex.toString().padStart(2, '0')}`;
                    
                    if (!data[monthKey]) {
                        data[monthKey] = {
                            incomes: {
                                person1: { name: 'Sandrine', amount: sandrineIncome },
                                person2: { name: 'Olivier', amount: olivierIncome }
                            },
                            expenses: []
                        };
                    }
                    
                    if (expenseName && expenseAmount > 0) {
                        const existingExpense = data[monthKey].expenses.find(e => e.name === expenseName);
                        if (!existingExpense) {
                            data[monthKey].expenses.push({
                                id: Date.now() + Math.random(),
                                name: expenseName,
                                amount: expenseAmount,
                                proportional: expenseType === 'Proportioneel'
                            });
                        }
                    }
                }
                
                return data;
            }, []);

            // Load data from Google Sheets
            const loadFromGoogleSheets = useCallback(async () => {
                console.log('loadFromGoogleSheets called');
                console.log('isGoogleAuthorized:', isGoogleAuthorized);
                console.log('gapi.client.sheets:', !!gapi.client.sheets);
                console.log('Current token:', gapi.client.getToken());
                
                if (!gapi.client.sheets) {
                    console.log('Cannot load from Google Sheets: client not ready');
                    return;
                }
                
                if (!gapi.client.getToken()) {
                    console.log('Cannot load from Google Sheets: no token available');
                    return;
                }

                try {
                    console.log('Loading data from Google Sheets...');
                    setIsSyncing(true);
                    setSyncError(null);
                    
                    const response = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: GOOGLE_CONFIG.SPREADSHEET_ID,
                        range: `${GOOGLE_CONFIG.SHEET_NAME}!A:H`
                    });
        
                    if (response.result.values && response.result.values.length > 1) {
                        const sheetData = parseSheetData(response.result.values);
                        setMonthlyData(sheetData);
                        setLastSync(new Date().toISOString());
                        console.log('Data loaded successfully from Google Sheets');
                    } else {
                        console.log('No data found in Google Sheets');
                    }
                } catch (error) {
                    console.error('Failed to load from Google Sheets:', error);
                    setSyncError(`Failed to load data: ${error.message}`);
                } finally {
                    setIsSyncing(false);
                }
            }, [isGoogleAuthorized, parseSheetData]);

            // Save data to Google Sheets
            const saveToGoogleSheets = useCallback(async () => {
                if (!isGoogleAuthorized || !gapi.client.sheets || !isOnline) {
                    console.log('Cannot save to Google Sheets: not authorized, client not ready, or offline');
                    return;
                }

                try {
                    console.log('Saving data to Google Sheets...');
                    setIsSyncing(true);
                    setSyncError(null);
                    
                    const values = convertToSheetFormat();
        
                    // Clear existing data
                    await gapi.client.sheets.spreadsheets.values.clear({
                        spreadsheetId: GOOGLE_CONFIG.SPREADSHEET_ID,
                        range: GOOGLE_CONFIG.SHEET_NAME
                    });

                    // Insert new data
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: GOOGLE_CONFIG.SPREADSHEET_ID,
                        range: `${GOOGLE_CONFIG.SHEET_NAME}!A1`,
                        valueInputOption: 'RAW',
                        resource: { values }
                    });

                    setLastSync(new Date().toISOString());
                    console.log('Data saved successfully to Google Sheets');
                } catch (error) {
                    console.error('Failed to save to Google Sheets:', error);
                    setSyncError(`Failed to save data: ${error.message}`);
                } finally {
                    setIsSyncing(false);
                }
            }, [isGoogleAuthorized, isOnline, monthlyData]);

            const signInToGoogle = useCallback(async () => {
                try {
                    console.log('Attempting Google sign-in...');
                    setSyncError(null);
                    
                    if (googleTokenClient) {
                        googleTokenClient.requestAccessToken();
                    } else {
                        throw new Error('Google token client not initialized');
                    }
                } catch (error) {
                    console.error('Google sign-in failed:', error);
                    setSyncError(`Sign-in failed: ${error.message}`);
                }
            }, [googleTokenClient]);

            const signOutFromGoogle = useCallback(async () => {
                try {
                    if (google.accounts.oauth2) {
                        google.accounts.oauth2.revoke(gapi.client.getToken().access_token, () => {
                            console.log('Token revoked');
                        });
                    }
                    gapi.client.setToken(null);
                    setIsGoogleAuthorized(false);
                    setLastSync(null);
                    setSyncError(null);
                    console.log('Google sign-out successful');
                } catch (error) {
                    console.error('Google sign-out failed:', error);
                    // Force reset anyway
                    setIsGoogleAuthorized(false);
                    setLastSync(null);
                }
            }, []);

            // Convert our data format to sheet format
            const convertToSheetFormat = useCallback(() => {
                const sheetData = [
                    ['Maand', 'Jaar', 'Sandrine Inkomen', 'Olivier Inkomen', 'Uitgave Naam', 'Uitgave Bedrag', 'Uitgave Type', 'Update Tijd']
                ];

                Object.entries(monthlyData).forEach(([monthKey, data]) => {
                    const [year, month] = monthKey.split('-');
                    const monthName = getMonthName(parseInt(month));

                    if (data.expenses.length === 0) {
                        sheetData.push([
                            monthName, year,
                            data.incomes.person1.amount, data.incomes.person2.amount,
                            '', '', '', new Date().toISOString()
                        ]);
                    } else {
                        data.expenses.forEach(expense => {
                            sheetData.push([
                                monthName, year,
                                data.incomes.person1.amount, data.incomes.person2.amount,
                                expense.name, expense.amount,
                                expense.proportional ? 'Proportioneel' : 'Fifty-fifty',
                                new Date().toISOString()
                            ]);
                        });
                    }
                });

                return sheetData;
            }, [monthlyData]);

            // Utility functions
            const getCurrentMonthKey = useCallback(() => {
                return `${selectedDate.year}-${selectedDate.month.toString().padStart(2, '0')}`;
            }, [selectedDate]);

            const getCurrentMonthData = useCallback(() => {
                const monthKey = getCurrentMonthKey();
                return monthlyData[monthKey] || {
                    incomes: {
                        person1: { name: 'Sandrine', amount: 0 },
                        person2: { name: 'Olivier', amount: 0 }
                    },
                    expenses: []
                };
            }, [monthlyData, getCurrentMonthKey]);

            const updateCurrentMonthData = useCallback((updates) => {
                const monthKey = getCurrentMonthKey();
                setMonthlyData(prev => ({
                    ...prev,
                    [monthKey]: {
                        ...getCurrentMonthData(),
                        ...updates
                    }
                }));
            }, [getCurrentMonthKey, getCurrentMonthData]);

            const navigateMonth = useCallback((direction) => {
                setSelectedDate(prev => {
                    let newMonth = prev.month + direction;
                    let newYear = prev.year;
                    
                    if (newMonth > 11) {
                        newMonth = 0;
                        newYear += 1;
                    } else if (newMonth < 0) {
                        newMonth = 11;
                        newYear -= 1;
                    }
                    
                    return { month: newMonth, year: newYear };
                });
            }, []);

            const getMonthName = useCallback((monthIndex) => {
                const months = [
                    'Januari', 'Februari', 'Maart', 'April', 'Mei', 'Juni',
                    'Juli', 'Augustus', 'September', 'Oktober', 'November', 'December'
                ];
                return months[monthIndex];
            }, []);

            const getMonthIndex = useCallback((monthName) => {
                const months = [
                    'Januari', 'Februari', 'Maart', 'April', 'Mei', 'Juni',
                    'Juli', 'Augustus', 'September', 'Oktober', 'November', 'December'
                ];
                return months.indexOf(monthName);
            }, []);

            const updateIncome = useCallback((person, amount) => {
                const currentData = getCurrentMonthData();
                const newIncomes = {
                    ...currentData.incomes,
                    [person]: { ...currentData.incomes[person], amount: parseFloat(amount) || 0 }
                };
                updateCurrentMonthData({ incomes: newIncomes });
            }, [getCurrentMonthData, updateCurrentMonthData]);

            const addExpense = useCallback(() => {
                if (newExpense.name && newExpense.amount > 0) {
                    const currentData = getCurrentMonthData();
                    const newExpenses = [...currentData.expenses, { ...newExpense, id: Date.now() }];
                    updateCurrentMonthData({ expenses: newExpenses });
                    setNewExpense({ name: '', amount: 0, proportional: true });
                }
            }, [newExpense, getCurrentMonthData, updateCurrentMonthData]);

            const deleteExpense = useCallback((id) => {
                const currentData = getCurrentMonthData();
                const newExpenses = currentData.expenses.filter(exp => exp.id !== id);
                updateCurrentMonthData({ expenses: newExpenses });
            }, [getCurrentMonthData, updateCurrentMonthData]);

            const currentData = getCurrentMonthData();
            const incomes = currentData.incomes;
            const expenses = currentData.expenses;

            // Calculations
            const bothIncomesEntered = incomes.person1.amount > 0 && incomes.person2.amount > 0;
            const totalIncome = incomes.person1.amount + incomes.person2.amount;
            const person1Ratio = totalIncome > 0 ? incomes.person1.amount / totalIncome : 0.5;
            const person2Ratio = totalIncome > 0 ? incomes.person2.amount / totalIncome : 0.5;

            const proportionalExpenses = expenses.filter(exp => exp.proportional);
            const fixedExpenses = expenses.filter(exp => !exp.proportional);

            const totalProportionalExpenses = proportionalExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const totalFixedExpenses = fixedExpenses.reduce((sum, exp) => sum + exp.amount, 0);

            const person1ProportionalShare = totalProportionalExpenses * person1Ratio;
            const person2ProportionalShare = totalProportionalExpenses * person2Ratio;
            const person1FixedShare = totalFixedExpenses / 2;
            const person2FixedShare = totalFixedExpenses / 2;
            const person1Total = person1ProportionalShare + person1FixedShare;
            const person2Total = person2ProportionalShare + person2FixedShare;

            // Analysis data
            const getAnalysisData = useCallback(() => {
                return Object.entries(monthlyData)
                    .sort(([a], [b]) => a.localeCompare(b))
                    .map(([monthKey, data]) => {
                        const [year, month] = monthKey.split('-');
                        const monthName = getMonthName(parseInt(month));
                        
                        const totalIncome = data.incomes.person1.amount + data.incomes.person2.amount;
                        const totalExpenses = data.expenses.reduce((sum, exp) => sum + exp.amount, 0);
                        
                        return {
                            monthKey,
                            monthName: `${monthName.slice(0, 3)} ${year}`,
                            fullMonth: `${monthName} ${year}`,
                            sandrineIncome: data.incomes.person1.amount,
                            olivierIncome: data.incomes.person2.amount,
                            totalIncome,
                            totalExpenses,
                            savings: totalIncome - totalExpenses,
                            sandrineRatio: totalIncome > 0 ? (data.incomes.person1.amount / totalIncome) * 100 : 50,
                            olivierRatio: totalIncome > 0 ? (data.incomes.person2.amount / totalIncome) * 100 : 50
                        };
                    });
            }, [monthlyData, getMonthName]);

            const analysisData = getAnalysisData();
            const chartColors = {
                sandrine: '#3B82F6',
                olivier: '#10B981',
                expenses: '#F59E0B',
                savings: '#8B5CF6'
            };

            if (isLoading) {
                return (
                    <div className="loading">
                        <div>
                            <div className="spinner"></div>
                            <p className="mt-4 text-gray-600">Data laden...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-6xl mx-auto p-6 bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
                    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                        {/* Header */}
                        <div className="gradient-bg p-6 text-white">
                            <div className="flex justify-between items-start mb-6">
                                <div>
                                    <h1 className="text-3xl font-bold">Budget Calculator</h1>
                                    <p className="text-indigo-100">Sandrine & Olivier</p>
                                </div>
                                
                                {/* Status Indicators */}
                                <div className="flex flex-col items-end gap-2">
                                    <div className={`flex items-center gap-2 px-3 py-1 rounded-full text-sm ${
                                        isOnline ? 'bg-green-500/20 text-green-100' : 'bg-red-500/20 text-red-100'
                                    }`}>
                                        <div className={`w-2 h-2 rounded-full ${isOnline ? 'bg-green-400' : 'bg-red-400'}`}></div>
                                        {isOnline ? 'Online' : 'Offline'}
                                    </div>
                                    
                                    {isSyncing && (
                                        <div className="flex items-center gap-2 px-3 py-1 rounded-full text-sm bg-blue-500/20 text-blue-100">
                                            <div className="w-2 h-2 rounded-full bg-blue-400 animate-pulse"></div>
                                            Syncing...
                                        </div>
                                    )}
                                    
                                    {lastSync && !isSyncing && (
                                        <div className="text-xs text-indigo-200">
                                            Laatste sync: {new Date(lastSync).toLocaleString('nl-NL')}
                                        </div>
                                    )}

                                    {isGoogleAuthorized ? (
                                        <button
                                            onClick={signOutFromGoogle}
                                            className="px-3 py-1 bg-red-600/80 text-white rounded text-xs hover:bg-red-600 transition-colors"
                                        >
                                            Disconnect Google
                                        </button>
                                    ) : googleApiLoaded ? (
                                        <button
                                            onClick={signInToGoogle}
                                            className="px-3 py-1 bg-green-600/80 text-white rounded text-xs hover:bg-green-600 transition-colors"
                                        >
                                            Connect Google Sheets
                                        </button>
                                    ) : (
                                        <div className="text-xs text-indigo-200">
                                            Google Sheets: Loading...
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* Tab Navigation */}
                            <div className="flex justify-center space-x-1 bg-white/10 backdrop-blur-sm rounded-lg p-1">
                                <button
                                    onClick={() => setActiveTab('budget')}
                                    className={`flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all duration-300 ${
                                        activeTab === 'budget' 
                                            ? 'bg-white text-indigo-600 shadow-lg' 
                                            : 'text-white hover:bg-white/20'
                                    }`}
                                >
                                    Budget
                                </button>
                                <button
                                    onClick={() => setActiveTab('analysis')}
                                    className={`flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all duration-300 ${
                                        activeTab === 'analysis' 
                                            ? 'bg-white text-indigo-600 shadow-lg' 
                                            : 'text-white hover:bg-white/20'
                                    }`}
                                >
                                    Analyse
                                </button>
                            </div>
                        </div>

                        <div className="p-8">
                            {/* Error/Success Messages */}
                            {syncError && (
                                <div className="error-banner">
                                    <div className="flex items-center gap-2">
                                        <div className="text-red-600 text-xl">⚠️</div>
                                        <div>
                                            <div className="font-medium text-red-800">Sync probleem</div>
                                            <div className="text-sm text-red-600">{syncError}</div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {isGoogleAuthorized && !syncError && lastSync && (
                                <div className="success-banner">
                                    <div className="flex items-center gap-2">
                                        <div className="text-green-600 text-xl">✅</div>
                                        <div>
                                            <div className="font-medium text-green-800">Google Sheets verbonden</div>
                                            <div className="text-sm text-green-600">Data wordt automatisch gesynchroniseerd</div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'budget' ? (
                                <>
                                    {/* Month Navigation */}
                                    <div className="mb-8 p-6 bg-indigo-50 rounded-lg">
                                        <div className="flex items-center justify-between">
                                            <button
                                                onClick={() => navigateMonth(-1)}
                                                className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                                            >
                                                ← Vorige
                                            </button>
                                            
                                            <div className="text-center">
                                                <h2 className="text-2xl font-bold text-gray-800">
                                                    {getMonthName(selectedDate.month)} {selectedDate.year}
                                                </h2>
                                                {Object.keys(monthlyData).includes(getCurrentMonthKey()) && (
                                                    <div className="text-sm text-green-600 font-medium mt-1">
                                                        ✓ Data opgeslagen
                                                    </div>
                                                )}
                                            </div>
                                            
                                            <button
                                                onClick={() => navigateMonth(1)}
                                                className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                                            >
                                                Volgende →
                                            </button>
                                        </div>
                                    </div>

                                    {/* Income Section */}
                                    <div className="mb-8 p-6 bg-green-50 rounded-lg">
                                        <h2 className="text-xl font-semibold text-gray-700 mb-4">
                                            Inkomsten voor {getMonthName(selectedDate.month)} {selectedDate.year}
                                        </h2>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-600 mb-2">
                                                    Sandrine
                                                </label>
                                                <input
                                                    type="number"
                                                    value={incomes.person1.amount || ''}
                                                    onChange={(e) => updateIncome('person1', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    placeholder="€ 0,00"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-600 mb-2">
                                                    Olivier
                                                </label>
                                                <input
                                                    type="number"
                                                    value={incomes.person2.amount || ''}
                                                    onChange={(e) => updateIncome('person2', e.target.value)}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                                    placeholder="€ 0,00"
                                                />
                                            </div>
                                        </div>
                                        <div className="mt-4 p-3 bg-white rounded-lg">
                                            {bothIncomesEntered ? (
                                                <>
                                                    <div className="text-sm text-gray-600">
                                                        Totaal inkomen: <span className="font-semibold">€{totalIncome.toFixed(2)}</span>
                                                    </div>
                                                    <div className="text-sm text-gray-600">
                                                        Verhouding: Sandrine {Math.round(person1Ratio * 100)}% | Olivier {Math.round(person2Ratio * 100)}%
                                                    </div>
                                                </>
                                            ) : (
                                                <div className="text-sm text-yellow-600 font-medium">
                                                    ⚠️ Vul beide lonen in om de verhouding te berekenen
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* Add Expense Section */}
                                    <div className="mb-8 p-6 bg-yellow-50 rounded-lg">
                                        <h2 className="text-xl font-semibold text-gray-700 mb-4">Nieuwe Uitgave Toevoegen</h2>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <input
                                                type="text"
                                                value={newExpense.name}
                                                onChange={(e) => setNewExpense({...newExpense, name: e.target.value})}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                                placeholder="Uitgave naam"
                                            />
                                            <input
                                                type="number"
                                                value={newExpense.amount || ''}
                                                onChange={(e) => setNewExpense({...newExpense, amount: parseFloat(e.target.value) || 0})}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                                placeholder="€ 0,00"
                                            />
                                            <div className="flex items-center gap-4">
                                                <label className="flex items-center gap-2">
                                                    <input
                                                        type="radio"
                                                        checked={newExpense.proportional}
                                                        onChange={() => setNewExpense({...newExpense, proportional: true})}
                                                        className="text-yellow-600"
                                                    />
                                                    <span className="text-sm">Proportioneel</span>
                                                </label>
                                                <label className="flex items-center gap-2">
                                                    <input
                                                        type="radio"
                                                        checked={!newExpense.proportional}
                                                        onChange={() => setNewExpense({...newExpense, proportional: false})}
                                                        className="text-yellow-600"
                                                    />
                                                    <span className="text-sm">50/50</span>
                                                </label>
                                            </div>
                                        </div>
                                        <button
                                            onClick={addExpense}
                                            className="mt-4 flex items-center gap-2 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors"
                                        >
                                            + Uitgave Toevoegen
                                        </button>
                                    </div>

                                    {/* Expenses List */}
                                    <div className="mb-8">
                                        <h2 className="text-xl font-semibold text-gray-700 mb-4">
                                            Uitgaven voor {getMonthName(selectedDate.month)} {selectedDate.year}
                                        </h2>
                                        {expenses.length === 0 ? (
                                            <div className="text-center py-8 text-gray-500 bg-gray-50 rounded-lg">
                                                Nog geen uitgaven toegevoegd voor deze maand
                                            </div>
                                        ) : (
                                            <div className="space-y-3">
                                                {expenses.map((expense) => (
                                                    <div key={expense.id} className="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                                                        <div className="flex items-center justify-between">
                                                            <div className="flex-1">
                                                                <div className="font-medium text-gray-800">{expense.name}</div>
                                                                <div className="text-sm text-gray-600">
                                                                    €{expense.amount.toFixed(2)} - {expense.proportional ? 'Proportioneel' : 'Fifty-fifty'}
                                                                </div>
                                                            </div>
                                                            <button
                                                                onClick={() => deleteExpense(expense.id)}
                                                                className="p-2 text-red-600 hover:bg-red-100 rounded transition-colors"
                                                            >
                                                                Verwijder
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    {/* Results Section */}
                                    {bothIncomesEntered ? (
                                        <div className="mb-8 p-6 bg-blue-50 rounded-lg">
                                            <h2 className="text-xl font-semibold text-gray-700 mb-4">Berekening</h2>
                                            
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div className="bg-white p-6 rounded-lg shadow-sm">
                                                    <h3 className="font-semibold text-blue-600 mb-3 text-lg">Sandrine</h3>
                                                    <div className="space-y-2 text-sm">
                                                        <div className="flex justify-between">
                                                            <span>Proportionele uitgaven:</span>
                                                            <span>€{person1ProportionalShare.toFixed(2)}</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span>Fifty-fifty uitgaven:</span>
                                                            <span>€{person1FixedShare.toFixed(2)}</span>
                                                        </div>
                                                        <hr className="my-2" />
                                                        <div className="flex justify-between font-semibold text-lg">
                                                            <span>Totaal te storten:</span>
                                                            <span className="text-blue-600">€{person1Total.toFixed(2)}</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="bg-white p-6 rounded-lg shadow-sm">
                                                    <h3 className="font-semibold text-green-600 mb-3 text-lg">Olivier</h3>
                                                    <div className="space-y-2 text-sm">
                                                        <div className="flex justify-between">
                                                            <span>Proportionele uitgaven:</span>
                                                            <span>€{person2ProportionalShare.toFixed(2)}</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span>Fifty-fifty uitgaven:</span>
                                                            <span>€{person2FixedShare.toFixed(2)}</span>
                                                        </div>
                                                        <hr className="my-2" />
                                                        <div className="flex justify-between font-semibold text-lg">
                                                            <span>Totaal te storten:</span>
                                                            <span className="text-green-600">€{person2Total.toFixed(2)}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="mt-6 p-4 bg-white rounded-lg text-center">
                                                <div className="text-sm text-gray-600 mb-2">Totale maandelijkse uitgaven</div>
                                                <div className="text-2xl font-bold text-gray-800">
                                                    €{(totalProportionalExpenses + totalFixedExpenses).toFixed(2)}
                                                </div>
                                                <div className="text-sm text-purple-600 font-medium mt-2">
                                                    Potentiële besparingen: €{(totalIncome - (totalProportionalExpenses + totalFixedExpenses)).toFixed(2)}
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="mb-8 p-6 bg-gray-100 rounded-lg text-center">
                                            <h2 className="text-xl font-semibold text-gray-500 mb-4">Berekening</h2>
                                            <div className="py-8">
                                                <div className="text-6xl mb-4">🧮</div>
                                                <div className="text-gray-500 mb-2">
                                                    Vul eerst beide lonen in om de berekening te zien
                                                </div>
                                                <div className="text-sm text-gray-400">
                                                    De verdeling wordt automatisch berekend zodra beide bedragen zijn ingevuld
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </>
                            ) : (
                                <div className="space-y-8">
                                    {/* Analysis Overview */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                        <div className="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl text-white">
                                            <div className="text-3xl mb-2">💰</div>
                                            <div className="text-2xl font-bold">
                                                €{analysisData.length > 0 ? (analysisData.reduce((sum, d) => sum + d.totalIncome, 0) / analysisData.length).toFixed(0) : '0'}
                                            </div>
                                            <div className="text-blue-100 text-sm">Gem. Maandinkomen</div>
                                        </div>
                                        
                                        <div className="bg-gradient-to-br from-amber-500 to-amber-600 p-6 rounded-xl text-white">
                                            <div className="text-3xl mb-2">🛒</div>
                                            <div className="text-2xl font-bold">
                                                €{analysisData.length > 0 ? (analysisData.reduce((sum, d) => sum + d.totalExpenses, 0) / analysisData.length).toFixed(0) : '0'}
                                            </div>
                                            <div className="text-amber-100 text-sm">Gem. Maanduitgaven</div>
                                        </div>
                                        
                                        <div className="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl text-white">
                                            <div className="text-3xl mb-2">💎</div>
                                            <div className="text-2xl font-bold">
                                                €{analysisData.length > 0 ? (analysisData.reduce((sum, d) => sum + d.savings, 0) / analysisData.length).toFixed(0) : '0'}
                                            </div>
                                            <div className="text-green-100 text-sm">Gem. Besparingen</div>
                                        </div>
                                        
                                        <div className="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-xl text-white">
                                            <div className="text-3xl mb-2">📊</div>
                                            <div className="text-2xl font-bold">
                                                {analysisData.length}
                                            </div>
                                            <div className="text-purple-100 text-sm">
                                                {analysisData.length === 1 ? 'Maand' : 'Maanden'} Data
                                            </div>
                                        </div>
                                    </div>

                                    {/* Manual Sync Button */}
                                    {isGoogleAuthorized && (
                                        <div className="flex justify-center">
                                            <button
                                                onClick={saveToGoogleSheets}
                                                disabled={isSyncing || !isOnline}
                                                className="flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                            >
                                                {isSyncing ? (
                                                    <>
                                                        <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                        Synchroniseren...
                                                    </>
                                                ) : (
                                                    <>
                                                        🔄 Handmatig synchroniseren
                                                    </>
                                                )}
                                            </button>
                                        </div>
                                    )}

                                    {/* Charts */}
                                    {analysisData.length > 0 && rechartsLoaded ? (
                                        <div className="space-y-8">
                                            {/* Income Trend */}
                                            <div className="bg-white p-6 rounded-xl shadow-lg">
                                                <h3 className="text-xl font-bold text-gray-800 mb-4">Inkomsten Ontwikkeling</h3>
                                                <ResponsiveContainer width="100%" height={300}>
                                                    <LineChart data={analysisData}>
                                                        <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                                                        <XAxis dataKey="monthName" stroke="#666" />
                                                        <YAxis stroke="#666" />
                                                        <Tooltip 
                                                            formatter={(value, name) => [`€${value.toFixed(2)}`, name]}
                                                            labelStyle={{ color: '#333' }}
                                                            contentStyle={{ backgroundColor: '#fff', border: '1px solid #ddd', borderRadius: '8px' }}
                                                        />
                                                        <Legend />
                                                        <Line 
                                                            type="monotone" 
                                                            dataKey="sandrineIncome" 
                                                            stroke={chartColors.sandrine} 
                                                            strokeWidth={3}
                                                            name="Sandrine" 
                                                            dot={{ fill: chartColors.sandrine, strokeWidth: 2, r: 4 }}
                                                        />
                                                        <Line 
                                                            type="monotone" 
                                                            dataKey="olivierIncome" 
                                                            stroke={chartColors.olivier} 
                                                            strokeWidth={3}
                                                            name="Olivier" 
                                                            dot={{ fill: chartColors.olivier, strokeWidth: 2, r: 4 }}
                                                        />
                                                    </LineChart>
                                                </ResponsiveContainer>
                                            </div>

                                            {/* Expenses vs Income */}
                                            <div className="bg-white p-6 rounded-xl shadow-lg">
                                                <h3 className="text-xl font-bold text-gray-800 mb-4">Inkomsten vs Uitgaven</h3>
                                                <ResponsiveContainer width="100%" height={300}>
                                                    <AreaChart data={analysisData}>
                                                        <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                                                        <XAxis dataKey="monthName" stroke="#666" />
                                                        <YAxis stroke="#666" />
                                                        <Tooltip 
                                                            formatter={(value, name) => [`€${value.toFixed(2)}`, name]}
                                                            labelStyle={{ color: '#333' }}
                                                            contentStyle={{ backgroundColor: '#fff', border: '1px solid #ddd', borderRadius: '8px' }}
                                                        />
                                                        <Legend />
                                                        <Area 
                                                            type="monotone" 
                                                            dataKey="totalIncome" 
                                                            stroke="#10B981" 
                                                            fill="#10B981"
                                                            fillOpacity={0.3}
                                                            name="Totaal Inkomen"
                                                        />
                                                        <Area 
                                                            type="monotone" 
                                                            dataKey="totalExpenses" 
                                                            stroke="#EF4444" 
                                                            fill="#EF4444"
                                                            fillOpacity={0.3}
                                                            name="Totale Uitgaven"
                                                        />
                                                        <Line 
                                                            type="monotone" 
                                                            dataKey="savings" 
                                                            stroke={chartColors.savings} 
                                                            strokeWidth={3}
                                                            name="Besparingen"
                                                            dot={{ fill: chartColors.savings, strokeWidth: 2, r: 4 }}
                                                        />
                                                    </AreaChart>
                                                </ResponsiveContainer>
                                            </div>

                                            {/* Monthly Overview Table */}
                                            <div className="bg-white p-6 rounded-xl shadow-lg">
                                                <h3 className="text-xl font-bold text-gray-800 mb-4">Maandelijks Overzicht</h3>
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead className="bg-gray-50">
                                                            <tr>
                                                                <th className="text-left p-3 font-semibold">Maand</th>
                                                                <th className="text-right p-3 font-semibold">Sandrine</th>
                                                                <th className="text-right p-3 font-semibold">Olivier</th>
                                                                <th className="text-right p-3 font-semibold">Totaal</th>
                                                                <th className="text-right p-3 font-semibold">Uitgaven</th>
                                                                <th className="text-right p-3 font-semibold">Bespaard</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {analysisData.slice().reverse().map((month, index) => (
                                                                <tr key={month.monthKey} className={index % 2 === 0 ? 'bg-gray-50/50' : ''}>
                                                                    <td className="p-3 font-medium">{month.fullMonth}</td>
                                                                    <td className="p-3 text-right">€{month.sandrineIncome.toFixed(2)}</td>
                                                                    <td className="p-3 text-right">€{month.olivierIncome.toFixed(2)}</td>
                                                                    <td className="p-3 text-right font-semibold">€{month.totalIncome.toFixed(2)}</td>
                                                                    <td className="p-3 text-right text-red-600">€{month.totalExpenses.toFixed(2)}</td>
                                                                    <td className={`p-3 text-right font-semibold ${month.savings >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                                        €{month.savings.toFixed(2)}
                                                                    </td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    ) : analysisData.length > 0 && !rechartsLoaded ? (
                                        <div className="bg-white p-6 rounded-xl shadow-lg text-center">
                                            <div className="text-4xl mb-4">📊</div>
                                            <h3 className="text-xl font-bold text-gray-600 mb-4">Grafieken laden...</h3>
                                            <p className="text-gray-500 mb-4">
                                                De bibliotheek voor grafieken wordt nog geladen. Probeer het over een paar seconden opnieuw.
                                            </p>
                                            
                                            {/* Fallback: Simple Table */}
                                            <div className="mt-8">
                                                <h4 className="text-lg font-semibold mb-4">Maandelijkse Data</h4>
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead className="bg-gray-50">
                                                            <tr>
                                                                <th className="text-left p-3 font-semibold">Maand</th>
                                                                <th className="text-right p-3 font-semibold">Totaal Inkomen</th>
                                                                <th className="text-right p-3 font-semibold">Uitgaven</th>
                                                                <th className="text-right p-3 font-semibold">Besparingen</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {analysisData.slice().reverse().map((month, index) => (
                                                                <tr key={month.monthKey} className={index % 2 === 0 ? 'bg-gray-50/50' : ''}>
                                                                    <td className="p-3 font-medium">{month.fullMonth}</td>
                                                                    <td className="p-3 text-right font-semibold">€{month.totalIncome.toFixed(2)}</td>
                                                                    <td className="p-3 text-right text-red-600">€{month.totalExpenses.toFixed(2)}</td>
                                                                    <td className={`p-3 text-right font-semibold ${month.savings >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                                        €{month.savings.toFixed(2)}
                                                                    </td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center py-16 bg-white rounded-xl shadow-lg">
                                            <div className="text-6xl mb-4">📊</div>
                                            <h3 className="text-2xl font-bold text-gray-600 mb-4">Nog geen data om te analyseren</h3>
                                            <p className="text-gray-500 mb-8">
                                                Voeg eerst inkomsten en uitgaven toe in de Budget tab om prachtige analyses te zien!
                                            </p>
                                            <button
                                                onClick={() => setActiveTab('budget')}
                                                className="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                                            >
                                                Ga naar Budget
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* Footer Info */}
                        <div className="px-8 pb-6">
                            <div className="bg-gradient-to-r from-gray-50 to-gray-100 p-4 rounded-lg">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-600">
                                    <div>
                                        <strong className="text-gray-800">Data Opslag:</strong>
                                        <br />In browser sessie + Google Sheets backup
                                    </div>
                                    <div>
                                        <strong className="text-gray-800">Auto-Sync:</strong>
                                        <br />Wijzigingen worden automatisch opgeslagen naar Google Sheets
                                    </div>
                                    <div>
                                        <strong className="text-gray-800">Status:</strong>
                                        <br />
                                        {googleApiLoaded ? 'Google Sheets API OK' : 'Google Sheets API Loading...'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<BudgetCalculator />, document.getElementById('root'));
    </script>
</body>
</html>
